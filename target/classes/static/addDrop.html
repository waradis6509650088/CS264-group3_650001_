<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>คำร้องขอเพิ่ม-ถอน รายวิชา</title>
    <link rel="icon" href="pic/TU.png" type="image/png">

</head>
<body>

<img src="pic/TU.png" alt="คำร้องขอเพิ่ม-ถอน รายวิชา" >
<h1 style="text-align: center;">คำร้องขอเพิ่ม-ถอน รายวิชา</h1>
<h2 style="text-align: center;">คณะวิทยาศาสตร์และเทคโนโลยี มหาวิทยาลัยธรรมศาสตร์ ศูนย์รังสิต</h2>

<label><star>*</star>แทน บังคับใส่ข้อมูล</label>
<link rel="stylesheet" type="text/css" href="addDropStyle.css">
<hr>
<form action="/courseRequest" method="post" id="request" >
    <label for="date">วันที่<star>*</star></label>
    <input type="number" id="date" name="date" min="1" max="31" placeholder="1-31" required>
    <script>
        const dateInput = document.getElementById("date");

        dateInput.addEventListener("input", function () {
            const enteredDate = parseInt(this.value);

            if (isNaN(enteredDate) || enteredDate < 1 || enteredDate > 31) {
                // ถ้าค่าที่ป้อนมาไม่ใช่ตัวเลขหรือไม่อยู่ในช่วง 1-31 ให้ลบตัวอักษรสุดท้าย
                this.value = this.value.slice(0, -1);
            }
        });
    </script>

    <label for="month">เดือน<star>*</star></label>
    <input type="text" id="month" name="month" placeholder="1-12"required>
    <script>
        const monthInput = document.getElementById("month");

        monthInput.addEventListener("input", function () {
            const enteredMonth = parseInt(this.value);

            if (isNaN(enteredMonth) || enteredMonth < 1 || enteredMonth > 12) {
                // ถ้าค่าที่ป้อนมาไม่ใช่ตัวเลขหรือไม่อยู่ในช่วง 1-12 ให้ลบตัวอักษรสุดท้าย
                this.value = this.value.slice(0, -1);
            }
        });
    </script>

    <label for="year">ค.ศ.<star>*</star></label>
    <input type="text" id="year" name="year" placeholder="19XX-2XXX"required><hr>

    <h3>ข้อมูลส่วนตัวนักศึกษา</h3>
    <label for="prefix">คำนำหน้าชื่อ(นาย/นาง/นางสาว):<star>*</star></label>
    <select id="prefix" name="prefix">
        <option value="นาย">นาย</option>
        <option value="นาง">นาง</option>
        <option value="นางสาว">นางสาว</option>
    </select>

    <label for="studentFirstName">ชื่อ:<star>*</star></label>
    <input type="text" id="studentFirstName" name="studentFirstName" required>

    <label for="studentLastName">นามสกุล:<star>*</star></label>
    <input type="text" id="studentLastName" name="studentLastName" required>

    <label for="studentId">เลขทะเบียน:<star>*</star></label>
    <input type="text" id="studentId" name="studentId" maxlength="10" placeholder="รหัสนัศศึกษา 10 หลัก" required>

    <label for="studentYear">ชั้นปีที่:<star>*</star></label>
    <input type="text" id="studentYear" name="studentYear" required>
    <script>
        const yearInput = document.getElementById("studentYear");

        yearInput.addEventListener("input", function () {
            const maxYear = 7; // กำหนดค่าสูงสุดเป็น 7

            if (parseInt(this.value) > maxYear) {
                // ถ้าค่าที่ป้อนมามากกว่า 7 ให้เซ็ตค่าใหม่เป็น 7
                this.value = "กรอกข้อมูลใหม่";
            }
        });
    </script>

    <label for="studyField">สาขาวิชา(ในคณะวิทยาศาสตร์และเทคโนโลยี):<star>*</star></label>
    <input type="text" id="studyField" name="studyField" required>
    <label for="advios">อาจารย์ที่ปรึกษา:<star>*</star></label>
    <input type="text" id="advios" name="advios" required>
    <hr>

    <h3>ข้อมูลที่สามารถติดต่อได้ทางไปรษณีย์</h3>
    <label for="addressNumber">บ้านเลขที่:<star>*</star></label>
    <input type="text" id="addressNumber" name="addressNumber" required>

    <label for="moo">หมู่:<star>*</star></label>
    <input type="text" id="moo" name="moo" required>

    <label for="tumbol">ตำบล:<star>*</star></label>
    <input type="text" id="tumbol" name="tumbol" required>

    <label for="amphur">อำเภอ:<star>*</star></label>
    <input type="text" id="amphur" name="amphur" required>

    <label for="province">จังหวัด:<star>*</star></label>
    <input type="text" id="province" name="province" required>

    <label for="postalcode">รหัสไปรษณีย์:<star>*</star></label>
    <input type="text" id="postalcode" name="postalcode" placeholder="รหัสไปรษณีย์ 5 หลัก" required>
    <script>
        const postalcodeInput = document.getElementById("postalcode");

        postalcodeInput.addEventListener("input", function () {
            // กำหนดความยาวสูงสุดให้เท่ากับ 5
            if (this.value.length > 5) {
                this.value = this.value.slice(0, 5);
            }
        });
    </script>

    <label for="mobilePhone">เบอร์โทรศัพท์:<star>*</star></label>
    <input type="text" id="mobilePhone" name="mobilePhone" placeholder="เบอร์โทรศัพท์ 10 หลัก"  required>
    <script>
        const mobilePhoneInput = document.getElementById("mobilePhone");

        mobilePhoneInput.addEventListener("input", function () {
            // กำหนดความยาวสูงสุดให้เท่ากับ 10
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });
    </script>

    <label for="Phone">เบอร์โทรศัพท์บ้าน(ถ้ามี):</label>
    <input type="text" id="Phone" name="Phone" >
    <script>
        const phoneInput = document.getElementById("Phone");

        phoneInput.addEventListener("input", function () {
            // กำหนดความยาวสูงสุดให้เท่ากับ 10
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });
    </script>

    <hr>


    <script>
        //script for adding content to table
        function addDropTable_addContent(){
            dat1 = document.getElementById("addDropChoice").value;
            dat2 = document.getElementById("subjectID").value;
            dat3 = document.getElementById("subjectName").value;
            dat4 = document.getElementById("studentSection").value;
            dat5 = document.getElementById("subjectDateTime").value;
            dat6 = document.getElementById("subjectCredit").value;
            dat7 = document.getElementById("subjectProfessor").value;
            dat8 = document.getElementById("addDropProfCheckChoice").value;

            //creating table
            table = document.getElementById("addDropTable");

            if(dat1 != "" &&
                dat2 != "" &&
                dat3 != "" &&
                dat4 != "" &&
                dat5 != "" &&
                dat6 != "" &&
                dat7 != "" &&
                dat8 != ""){

                let row = table.insertRow(-1);
                row.id = "tableRow_" + table.rows.length;

                c1 = row.insertCell(0);
                c2 = row.insertCell(1);
                c3 = row.insertCell(2);
                c4 = row.insertCell(3);
                c5 = row.insertCell(4);
                c6 = row.insertCell(5);
                c7 = row.insertCell(6);
                c8 = row.insertCell(7);

                c1.innerText = dat1;
                c2.innerText = dat2;
                c3.innerText = dat3;
                c4.innerText = dat4;
                c5.innerText = dat5;
                c6.innerText = dat6;
                c7.innerText = dat7;
                c8.innerText = dat8;


                //reset input field
                document.getElementById("subjectID").value = "";
                document.getElementById("subjectName").value = "";
                document.getElementById("studentSection").value = "";
                document.getElementById("subjectDateTime").value = "";
                document.getElementById("subjectCredit").value = "";
                document.getElementById("subjectProfessor").value = "";
            }
        }

        //script for delete subject in the table
        function addDropTable_deleteSubject(){
            rowCount = document.getElementById('addDropTable').rows.length;
            if(rowCount != 1){
                table = document.getElementById("addDropTable").deleteRow(-1);
            }

        }

        //script for turning table to array
        function toJSONstring() {
            const table = document.getElementById("addDropTable");

            if(table.rows.length > 1){
                addSubObj = [];
                dropSubObj = [];

                for(i = table.rows.length; i > 1 ; i--){
                    datTable = document.getElementById("tableRow_" + i);
                    console.log(datTable.innerText);
                    cells = datTable.getElementsByTagName("td");
                    obj = {
                            "subjectCode" : cells[1].innerText,
                            "subjectName" : cells[2].innerText,
                            "subjectSection" : cells[3].innerText,
                            "subjectDate" : cells[4].innerText,
                            "subjectCredit" : cells[5].innerText,
                            "subjectTeacher" : cells[6].innerText,
                            "subjectTeacherCheck" : cells[7].innerText == "อนุญาต"? true : false
                        }
                    if(cells[0].innerText == "เพิ่ม"){
                        addSubObj.push(obj);
                    }
                    else{
                        dropSubObj.push(obj);
                    }
                }
            }
            else{
                console.log("no data");
            }
            myJson = {
                "addSubjectList" : addSubObj,
                "dropSubjectList" : dropSubObj,
            }

            console.log(myJson);

            studentJson = {
                "date":document.getElementById("dateTime").value,
                "studentFirstName":document.getElementById("namePrefix").value + " " + document.getElementById('studentFirstName').value,
                "studentLastName":document.getElementById("studentLastName").value,
                "studentId":document.getElementById("studentId").value,
                "studentYear":document.getElementById("studentYear").value,
                "studyField":document.getElementById("studyField").value,
                "advisor":document.getElementById("advisor").value,
                "addressNumber":document.getElementById("addressNumber").value,
                "moo":document.getElementById("moo").value,
                "tumbol":document.getElementById("tumbol").value,
                "amphur":document.getElementById("amphur").value,
                "province":document.getElementById("province").value,
                "postalCode":document.getElementById("postalCode").value,
                "mobilePhone":document.getElementById("mobilePhone").value,
                "phone":document.getElementById("phone").value,
                "cause":document.getElementById("cause").value
            };
            result = jsonConcat(studentJson,myJson)

            return JSON.stringify(result);
        }


        function jsonConcat(o1, o2) {
            for (var key in o2) {
            o1[key] = o2[key];
            }
            return o1;
        }

        document.addEventListener("submit", (e) => {
        e.preventDefault();
        let table = document.getElementById("addDropTable");

        if (table.rows.length < 2) {
            alert("กรุณาเพิ่ม/ถอนอย่างน้อย 1 วิชาก่อนยืนยัน");
        } else {
            studentString = toJSONstring();
            fetch('/formSubmit?studentInfoJSONstring='+ encodeURIComponent(studentString))
            .then(response => response.text())
            .then(data => console.log(JSON.parse(studentString)))
            .catch(error => console.error('Error:', error));
            alert("ส่งแบบฟอร์มสำเร็จ!");
            //location.reload();
        }
        });


    </script>
    <h3>วิชาที่ต้องการเพิ่ม/ถอน :</h3>
    <table id="addDropTable">
        <tr id="addDropTableHead">
            <th>ต้องการ</th>
            <th>รหัสวิชา</th>
            <th>ชื่อวิชา</th>
            <th>section</th>
            <th>วัน/เวลา</th>
            <th>หน่วยกิต</th>
            <th>ชื่อผู้สอน</th>
            <th>ผู้สอนอนุญาต</th>
        </tr>
    </table>
    <br>
    <div id="addDropButtonDiv">
        <select id="addDropChoice">
            <option value="เพิ่ม">เพิ่ม</option>
            <option value="ถอน">ถอน</option>
        </select>
        <input type="text" id="subjectID" name="subjectID" placeholder="รหัสวิชา" >
        <input type="text" id="subjectName" name="subjectName" placeholder="วิชา" >
        <input type="text" id="studentSection" name="studentSection" placeholder="section" >
        <input type="text" id="subjectDateTime" name="subjectDateTime" placeholder="วัน/เวลาที่เรียน" >
        <input type="text" id="subjectCredit" name="subjectCredit" placeholder="จำนวนหน่วยกิต" >
        <input type="text" id="subjectProfessor" name="subjectProfessor" placeholder="ชื่อผู้สอน" >
        <select id="addDropProfCheckChoice" name="addDropProfCheckButton">
            <option value="อนุญาต">อนุญาต</option>
            <option value="ไม่อนุญาต">ไม่อนุญาต</option>
        </select>

    </div>
    <br>
    <input type="button" id="addDropTable_addSubjectButton" onclick="addDropTable_addContent()" value="เพิ่มรายการ">
    <input type="button" id="DeleteaddDropTable_addSubjectButton" style="width: 25%;" onclick="addDropTable_deleteSubject()" value="ลบรายการล่าสุด">
    <br><br>
    <label for="cause">เหตุผลที่ขอการเพิ่มถอน<star>*</star></label>
    <textarea id="cause" name="cause" required></textarea><br>

    <button>ส่งแบบฟอร์ม</button>


</form>
<script>
    function validateForm() {
        var addSubjectCount = parseInt(document.getElementById("addsubject").value);
        var dropSubjectCount = parseInt(document.getElementById("dropsubject").value);

        if (addSubjectCount + dropSubjectCount < 1) {
            alert("ต้องมีอย่างน้อย 1 รายวิชาที่จะขอเพิ่มหรือถอน");
            return false;
        }
        return true;
    }
</script>

</body>
</html>